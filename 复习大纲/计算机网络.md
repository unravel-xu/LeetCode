# 绪论
层次间接口定义了下层向上层提供哪些原语操作和服务
协议的组成：
	语法：二进制形式表示的命令和相应的结构
	语义：由发出的命令请求，完成的动作和回送的响应组成的集合
	定时关系：相关事件顺序的说明
网络体系结构不提供协议内部实现细节
服务：某一层向它上一层提供的一组原语(操作)
服务对用户可见，协议对用户不可见
服务访问点 SAP：
	任何层间服务是在接口的 SAP 上进行
	每个 SAP 有唯一的识别地址
	每个层间接口可以有多个 SAP
接口数据单元 IDU：
	IDU 是通过 SAP 进行传送的层间信息单元
	IDU 由上层的服务单元 SDU 和接口控制信息 ICI 组成
协议数据单元 PDU：
	第 N 层实体通过网络传送给它的对等实体的信息单元
	PDU 由上层服务数据单元 SDU 或其分段和协议控制信息 PCI 组成
	分段和重组
面向连接的服务：连接建立时，发送方、接收方和子网一起协商
	变体：消息序列（会保持消息的边界 2\*1024B 不会变成 2048B）、字节流（没有消息边界）
无连接的服务(数据报服务)：每条报文携带目标地址，可以被系统独立路由，但无法保证到达时序
点到点：网络中直接连接两个终端设备
端到端：从数据产生(信息的源头，端口)到数据接收(信息的目的地)
## OSI 参考模型
![|400](Images/Pasted%20image%2020241211134759.png)
表示层：处理两个通信系统中信息交换的表示问题，包括
	数据格式化
	数据加密和压缩
	数据转换
	异常处理
会话层：管理和控制两个通信系统之间的会话，确保数据交换按预定的会话流程进行
	会话的建立、维护和终止
	数据的同步和排序
	会话数据的分割和管理
	多个同时进行会话管理
OSI 的网络层同时支持无连接和面向连接的通信
OSI 的传输层只支持面向连接的通信
## TCP/IP 模型
![|400](Images/Pasted%20image%2020241211135204.png)
将物理层和数据链路层合并为：Host-to-Network
	物理层：物理线路上传输原始的二进制数据位
	数据链路层：在有差错的物理线路上提供无差错的数据传输
网络层：控制通信子网提供源点到目的点 IP 包传送，实现异构网络互联
传输层：端到端(端口)的数据传送服务，TCP 和 UDP
应用层：提供各种 Internet 管理和应用服务功能
TCP/IP 的网路层只支持无连接通信
TCP/IP 的传输层同时支持两种通信（和 OSI 相反）
## 5 层模型
![|400](Images/Pasted%20image%2020241211141440.png)
![|650](Images/Pasted%20image%2020241211140117.jpg)
- 物理层(什么都不加)：确保原始的数据在各种物理媒介上传输
- 数据链路层(加头加尾)：将源自网络层来的数据可靠地传输到相邻节点的目标机网络层
	  主要的协议：以太网协议
	  设备：网桥和交换机
- 网络层(加头)：负责对子网间的数据包进行路由选择、拥塞控制……
	  主要的协议：IP、ICMP、ARP、RARP
	  设备：路由器
- 传输层(加头)：网络层点对点，传输层将点对点数据传送到对应端口
	  主要的协议：TCP、UDP
	  设备：网关
- 应用层(加头)：提供访问网络服务接口
	  主要的协议：FTP、Telnet、DNS、SMTP、POP3、HTTP
## 性能指标
### 速率
KB = $2^{10}$ B
kb/s = $10^3$ bps
### 带宽
- 在模拟信号系统中，带宽是指信号所包含的各种不同频率成分所占据的<font color="#c0504d">频率范围</font>，单位 Hz
- 在计算机网络中，带宽是指单位时间内从网络中某一点到另一点所能通过的“最高数据率”，单位 b/s
### 吞吐率
在单位时间内通过某个网络（或信道、接口）的数据量
### 时延
发送时延 = $\frac{分组长度}{发送速率}$
传播时延 = $\frac{信道长度}{电磁波传播速率}$
处理时延（一般忽略）
网络时延 = 发送时延 + 传播时延 + 处理时延
1. 某数据块长度为 100MB，信道带宽为 1Mb/s，传送距离 1000km
发送时延 = $\frac{100MB}{1Mb/s} = \frac{100*2^{20}*8(b)}{10^6(b/s)} = 838.8608(s)$
传播时延 = $\frac{1000Km}{2*10^8(m/s)}=0.005(s)$
此时发送时延占主导
2. 数据块长度为 1B，信道宽度为 1Mb/s，传送距离 1000Km
发送时延 = $8*10^{-6}(s)$
传播时延 = 0.005(s)
此时传播时延占主导
### 时延带宽积
时延带宽积 = 单向传播时延 \* 带宽
当发送端连续发送数据，在所发送的第一个比特即将到达终点时，发送端已经发送了时延带宽积个比特
### 往返时间
即 RTT = 2 \* 传播时延
## 习题
1. ISO/OSI 模型中的（数据链路）层会在处理协议元数据的时候在数据首尾添加信息
2. 在 TCP/IP 模型中，由传输层相邻的下一层实现的主要功能（B）
   （A）对话管理
   （B）路由选择
   （C）端到端报文段传输
   （D）结点到结点流量控制
3. 下图描述的协议要素是
	I.语法 II.语义 III.时序
	（A）仅 I
	（B）仅 II 
	（C）仅 III
	（D）I，II，III
![|200](Images/Pasted%20image%2020241211141615.png)
	选C
4. OSI 参考模型的第 5 层（自下而上）完成的主要功能？
   会话管理
5. 在 OSI 参考模型中，直接为会话层提供服务的是？
   传输层
6. 在 OSI 参考模型中，自下而上第一个提供端到端服务的层次是？
   传输层
# 物理层
物理层接口特性：
	机械特性：接口所用接线器的形状和尺寸等
	电气特性：在接口电缆的各条线上传输比特流时，信号电压的范围等
	功能特性：接口电缆的各条信号线的作用
	过程特性：在信号线上进行比特流传输的一组操作过程
## 导向的传输媒体
同轴电缆：
	基带同轴电缆：用于数字传输，早期局域网中广泛使用
	带宽同轴电缆：用于模拟传输，有线电视的入户线
![|350](Images/Pasted%20image%2020241211174247.png)
双绞线：两根线绞在一起后
	减少相邻导线间的电磁干扰
	抵御部分来自外界的电磁干扰
	常用于电话系统，可用于模拟传输，也可用于数字传输
对于模拟传输：距离太长需要添加放大器设备，以便将衰减了的信号放大到合适的强度
对于数字传输：距离太长需要添加中继设备，以便对失真了的数字信号进行整形

光纤：多模光纤、单模光纤
光源：LED、半导体光源

|      | LED | 半导体激光 |
| :--: | :-: | :---: |
| 数据速率 |  低  |   高   |
| 光纤类型 | 多模  | 多模/单模 |
|  距离  |  短  |   长   |
|  寿命  |  长  |   短   |
|  成本  |  低  |   高   |
光纤对比铜线：
- 优点：能处理更高带宽、更少的中继器，节约成本
- 缺点：光电接口成本更高
## 非导向型传输媒体
无线电传输：一般来说低频全方向传播，穿透性好；高频直线传播，穿透性差
微波传输：一般是直线传播，穿透性差
红外传输：短距离通信，不能穿越固体
光通信：非导向性光通信提供了一种灵活、高速的无线传输方式，但它的传输距离和稳定性受到大气条件的影响
![|450](Images/Pasted%20image%2020241211160353.png)
## 编码与调制
![](Images/Pasted%20image%2020241211183126.png)
基本调制方法：
![|500](Images/Pasted%20image%2020241211185732.png)
使用基本调制方法：一个码元只能包含一个比特信息
# 数据链路层
![|400](Images/Pasted%20image%2020241211213117.png)
数据链路层来将比特流拆分成离散的帧，为每一帧计算一个名为校验和的短令牌，并将该校验和放在帧中一起传输
成帧的方法：
- 字节计数法
  帧头的字节数包括帧头本身，可能因为传输错误而出错，很少使用
  ![](Images/Pasted%20image%2020241211214754.png)
- 字节填充的标志字节法
  每一帧用特殊的字节（FLAG 标志字节）作为开始和结束，两个连续的 FLAG 代表了一帧的结束和下一帧的开始
![|500](Images/Pasted%20image%2020241211215114.png)
- 比特填充的标志比特法
  每个帧开始和结束由一个特殊的比特模式：0111 1110(0x7E)进行标记
  数据中遇到连续 5 个 1 填入一个 0
  ![](Images/Pasted%20image%2020241211215705.png)
- 物理层编码例外法
  利用保留的信号指示帧的开始和结束，比如，在 4B/5B 线路编码模式下，32 个可能的信号中有 16 个是不会被使用的
## 简单的数据链路层协议
协议 1，Utopia(乌托邦)：无流量控制或错误纠正
- 数据只能单向传输
- 其他各种条件理想化
- 只是显示要建立的基本结构
协议 2，增加流量控制：停-等式协议
- 假设信道不出错
- 假设流量是单工的
- 发送方发送一帧，等待确认(仅用于控制流量，而非确认数据是否出错)后继续发送
- 数据流量是双工的，帧可以两个方向传送（不矛盾，传回来的不是“数据”而是确认帧）
- 发送方在从网络层获取下一个数据包前必须等待，直到确认帧到来
协议 3，增加错误纠正功能
- 信道可能出错
- 假设错误能被检测出来
- 如果在一个协议中，发送方在前移到下一个数据包以前要等待一个肯定确认，这样的协议称为 ARQ 协议或 PAR 协议
- 和协议 2 相同，这类协议只在一个方向上传输数据
## 更高效率
双向传输：捎带确认
- 收到数据帧，不立即发送单独的 ACK，而是将确认信息附加在下一个自己往外的数据帧上
- 等待固定毫秒数，如果一个新的数据包很快就到来，那么这个确认就可被它捎带回去；如果在这段间隔结束以前没有新的数据包到来，那么数据链路层只需发送一个单独的确认帧
滑动窗口：
- 每一个出去的帧都包含一个序号，范围为 0~某个最大值(通常 $2^n-1$)
- 发送方维护发送窗口：序号代表已经被发送或者可以被发送，但还没有被确认的帧。新的数据包被赋予窗口中的下一个最高序号，并且发送窗口的上边界前移一格；当收到一个确认时，发送窗口的下边界也“前移一格”（具体看协议）
- 接收方维护接收窗口：对应于允许它接收的帧
回退 n 协议：
- 允许发送方在阻塞前发送 w 个帧，而不只是一个帧
- BD：$\frac{时延带宽积}{一帧的位数}$
- 当发送方连续发送帧并在一个 RTT 内收到一个 ACK，则 2BD 是发送方可以连续发出去的帧的个数
- 发送窗口最大值 w = 2BD + 1，此时是理想情况，在发送了第 2BD+1 个帧后瞬间收到了第一个帧的 ACK，发送窗口前移
- 链路利用率 $\leq \frac{w}{1+2BD}$
- 实际利用率 = $\frac{T_f}{T_s+RTT+T_a}$
  $T_s=\frac{数据帧位数}{信道带宽}$ (发送时延)，$T_f = T_s*发的帧的个数$，$T_a = \frac{确认帧位数}{信道带宽}$
- 实际最大数据传输率 = $\min{\left\{ \frac{帧长度*窗口大小}{T_s+RTT+T_a},信道带宽 \right\}}$
## GBN 协议
- 接收窗口尺寸是 1
- 若不出错，接收窗口向下移动，并发送 ACK
- 若出错，<font color="#c0504d">丢弃该帧以及后续的所有帧</font>，对后续的帧不发 ACK
	- 出错帧超时重发，出错帧的后续帧超时后也依次重发
- 采用累计确认：当 n 号帧的确认到达时，< n 号帧都会自动确认
- 发送窗口最大尺寸 $2^{n}-1$
## SR 协议
- 接收/发送窗口尺寸>1
- 收到接收窗口外的帧，丢弃
- 收到接收窗口内的帧，保留
- 如果按序收到，窗口移动一格(上下边界+1)
- 如果收到的帧不是按序，对断序位置发回 NAK，例如收到 0，1，3，发回 NAK2
- 接收方收到误码的数据分组后将其丢弃，给发送方发送相应的 NAK，发送方收到 NAK 后，会立即重传
- 按书上是累计确认，实际依情况分析，通常是逐一确认
- 发送窗口和接收窗口一般相同，且两者和 $\leq 2^n$
例：序号为 0~13，若发送窗口大小为 7，为了使传输不出错，接受窗口最大为？
发送窗口+接收窗口 $\leq$ 总序号数，接受窗口最大 14-7=7
## PPP 协议
包含两部分 LCP（链路控制协议）、NCP（网络控制协议）
- 面向字节而非比特，使用字节填充技术，所有帧长度是字节整数倍
  ![](Images/Pasted%20image%2020241212195435.png)
  将原信息字段中出现的每一个 0x7E->7D,5E
  若原信息字段中有 0x7D->7D,5D
- 通常提供无连接无确认服务，也可使用有序号可靠传输
## 习题
1. 链路层成帧的方法不包括？
   A.偏移量法
   B.物理层编码违例法
   C.带位填充首尾字节标记法
   D.字符计数法
   选 A
2. 主机甲与主机乙之间使用GBN 协议传输数据，甲的发送窗口尺寸为 1000，数据帧长为 1000 字节，信道带宽为 100Mbps，乙每收到一个数据帧立即利用一个短帧（忽略其传输延迟）进行确认，若甲、乙之间的单向传播时延是 50ms，则甲可以达到的最大平均数据传输速率约为？
   帧长度：1000B，窗口大小：1000，$T_s=\frac{1000B}{100Mbps}$，RTT=100ms
   实际最大数据传输率 = $\min{\left\{ \frac{1000*8*1000}{\frac{1000*8}{100*10^6}+0.1}*10^{-9}Mbps,100Mbps \right\}}=\min{\{79.9361, 100\}}\approx80Mbps$
3. 主机甲通过 128kb/s 卫星链路，采用滑动窗口协议向主机乙发送数据，链路单向传播时延为 250ms，帧长为 1000 字节，不考虑确认帧的开销，为使链路利用率不小于 80%，帧序号的比特数至少是？
   ![|500](Images/Pasted%20image%2020241212190532.png)
4. 太空站到地球带宽为 128kbps 的无错信道上单向发送 512 字节的数据帧，端到端的传播延迟 300ms，确认帧长度忽略不计，接收窗口足够大，问发送窗口分别为1，15，27 时，吞吐率（数据发送速率）是多少？若要使信道利用率达到最大，则帧序号至少为多少位？
   ![|500](Images/Pasted%20image%2020241212190703.png)
5. 两地相距 3000 公里 (传播速度 6us/公里) 最大帧 64 字节，采用 GBN协议，带宽为 1.536Mbps，则若要最大限度发挥网络带宽，至少需要多少比特的序号？
   最大限度发挥网络带宽->实际最大数据传输速率=信道带宽
   ![|500](Images/Pasted%20image%2020241212190926.png)
6. 数据链路层采用 GBN 协议，发送方已经发送了编号 0~7 的帧，当计时器超时时，若发送方只收到了 0，2，3 号帧的确认，则发送方需要重发的帧数是？
   累计确认，所以是 4~7 共 4 个帧
7. 在选择重传协议中,当前发送方的发送窗口为\[1,2,3,4\]，收到了一个接收方的否定确认帧，则可能的情况是？
   (A)一定是 1 
   (B)一定是 2 
   (C)一定是 3 
   (D)可能是 1,2,3,4
   发送 NAK 对应两种情况：
   1）校验数据出错，立马发送 NAK
   2）收到 n+m($m\geq1$)，还没收到 n，发送 NAKn
   如果是情况 1）则1，2，3，4 都可能，选 D
   如果是情况 2）一定不可能是 1 和 4，可能是 2 或 3
   综合两种情况，选 D
8. 甲乙双方均采用后退N帧协议（GBN）进行持续的双向数据传输，且双方始终采用捎带确认，帧长均为1000 B。$S_{x,y}$ 和 $R_{x,y}$ 分别表示甲方和乙方发送的数据帧，其中：x是发送序号；y是确认序号（表示希望接收对方的下一帧序号）数据帧的发送序号和确认序号字段均为3比特。信道传输速率为100Mbps，RTT=0.96ms。下图给出了甲方发送数据帧和接收数据帧的两种场景，其中$t_0$为初始时刻，此时甲方的发送和确认序号均为0，$t_1$时刻甲方有足够多的数据待发送。
   ![|400](Images/Pasted%20image%2020241212192935.png)
   请回答下列问题。
   (1) 对于图（a）$t_0$ 时刻到 $t_1$ 时刻期间，甲方可以断定乙方已正确接收的数据帧数是多少？正确接收的是哪几个帧（请用 $S_{x,y}$ 形式给出）？
   ![|500](Images/Pasted%20image%2020241212193357.png)
   (2)对于图（a）从 $t_1$ 时刻起，甲方在不出现超时且未收到乙方新的数据帧之前，最多还可以发送多少个数据帧？其中第一个帧和最后一个帧分别是哪个（请用 $S_{x,y}$ 形式给出）？
    ![|500](Images/Pasted%20image%2020241212193555.png)
   (3)对于图（b）从 $t_1$ 时刻起，甲方在不出现新的超时且未收到乙方新的数据帧之前，需要重发多少个数据帧？重发的第一个帧是哪个（请用 $S_{x,y}$ 形式给出）？
   $R_{2,2}$ -> 甲收到了乙发的 0~2 号帧，乙只收到了甲发的 0~1 号帧，所以甲需要重传从 2 号开始的所有已发帧，也就是 2~4 号帧。且 S 中 y=3，所以重发的第一个帧是 $S_{2,3}$
9. 408 中 SR 逐个确认，数据链路层采用 SR 传输数据，发送方已发送了 0~3 号数据帧，现已收到 1 号帧的确认，而 0、2 号帧依次超时，则此时需要重传的帧数是？
   重传 0，2 两个帧（912 中看情况，如果题目出现 ACK1，但 0 号帧超时，说明必定不是累计确认）
10. A 向 B 传输 8 个定长分组，每组传输结束后启动定时器，分组长度 L bits，链路速率 C bps，单向传播延时 Ts，T >> L/C，假设 A 的发送窗口足够大，采用超时重传机制，超时时间为 2 倍的单向传播延时,分别采用退回 n 帧、选择性重传和否定性确认机制（否定性确认分组时延可忽略）实现可靠传输，假定分组间无间隙，若第 2 组（从 1 开始）出现误码，之后无错，选择性重传和否定性确认接收窗口足够大，则采用以上三机制，从开始发送第一个分组到正确接收第八个分组分别需要多少时间？
    超时重传时间 = 1 个 RTT
    ![](Images/Pasted%20image%2020241213105122.png)
    采用超时重传，一次 A->B，等超时，一次 A->B
    采用NAK，一次 A->B，一次 B->A(NAK)，一次 A->B
    ![](Images/Pasted%20image%2020241213105401.png)    
# MAC 子层
MAC（介质访问控制子层）属于数据链路层的一个子层，用于确定广播信道（多路访问信道）下一个使用者
局域网使用广播信道，广域网有些部分使用点到点链路(PPP 协议)
## 信道分配
静态信道分配：FDM、TDM、CDM，不适应突发性流量
动态信道分配的假设：
	流量独立：帧的到达时独立的
	单信道：都是用一条信道，才可能冲突
	冲突可观察：能够检测到冲突
	时间连续或分槽：连续指传输帧的时间任意时刻都可以，分槽指帧传输只能从某个时间槽起点开始
	载波侦听或不听：在使用前知道信道是否正在被占用
后三个是否成立看具体的协议
## 多路访问协议
没有多路访问协议能保证可靠传送
### ALOHA
纯 ALOHA
- 有数据就发
- 如果帧被损坏了，发送方等待一段随机时间然后重发
- 无论何时，只要两个帧在相同时间试图占用信道，冲突就会发生，且两个帧都会被损坏
- 传输前不会侦听信道
- 帧时 = $\frac{帧长度}{比特率}$：表示传输一个标准的、固定长度的帧需要的时间
- 平均每帧时产生 G 个帧（已经被破坏了的旧帧和重传的新帧都考虑），吞吐量 $S=GP_0$, $P_0$ 是成功传输的概率（传输这一帧没有发生冲突的概率）
![|400](Images/Pasted%20image%2020241212203048.png)
分槽 ALOHA
- 时间槽长度等于帧时
- 有数据要发也只能在下一个时间槽开始位置发送帧（得等一个时间槽之内的时间）
![|350](Images/Pasted%20image%2020241212203406.png)
### CSMA
载波侦听多路访问协议
多路访问：多个用户共用一条线路
1-坚持型 CSMA
- 1-坚持：因为当站发现信道空闲时，它传输数据的概率为 1
- 当一个站有数据要发送时，它首先侦听信道
- 如果信道空闲，它就立刻发送数据
- 如果信道忙，该站就等待到信道变成空闲，然后发送一帧
- 如果发生冲突，该站等待一段随机长度的时间，然后再重新开始发送过程
- 优点：减少了信道空闲时间
- 缺点：增加了发生冲突的概率，传播时延越大，发生冲突的概率越大
非坚持型 CSMA
- 当一个站有数据要发送时，它首先侦听信道
- 如果信道空闲，它就立刻发送数据
- 如果信道忙，等待一段随机的时间，然后重新开始发送过程(区别)
- 如果产生冲突，等待一段随机的时间，然后重新开始发送过程
- 优点：减少了冲突的概率
- 缺点：增加了信道空闲时间，数据发送延迟增大
P-坚持型 CSMA
- 使用时槽周期
- 若站点有数据发送，先监听信道
- 若站点发现信道空闲，则以概率 p 发送数据，以概率 q=1-p 延迟至下一个时槽发送。若下一个时槽仍空闲，重复此过程，直至数据发出或时槽被其他站点所占用
- 若信道忙，则等待下一个时槽，重新开始发送过程
- 若产生冲突，等待一随机时间，然后重新开始发送过程
![|500](Images/Pasted%20image%2020241212203911.png)
CSMA/CD（带冲突检测的 CSMA）
- 以太网使用 CSMA/CD
- 站点使用 CSMA 协议进行数据发送
- 在发送期间若检测到冲突，立即终止发送，并发出信号通知所有站点
- 在发出信后后，等待一段随机时间，再新开始发送过程
- 竞争槽长度两倍传播时延
- 半双工
![|500](Images/Pasted%20image%2020241212204659.png)
### 无冲突协议
假设传播时延忽略不计
- 基本位图法
- 令牌传递法（逻辑环，每个站知道它的前一站和后一站）
- 二进制倒计数（信道利用率 100%）
### 有限竞争协议
竞争方法：如 CSMA
	轻负载下，发送延迟小；重负载下，信道效率低
无冲突方法：如基本位图法
	轻负载下，发送延迟大；重负载下，信道效率高
有限竞争方法：
	结合以上两种方法，轻负载下使用竞争，重负载下使用无冲突方法
	将站分组，组内竞争
### 无线 LAN 协议
隐藏站点问题
	由于站点距离竞争者太远，而不能发现潜在介质竞争者的问题称为隐藏站点问题
	A 向 B 发送数据的过程中，C 由于收不到 A 的数据，也可以向 B 发送数据，导致 B 接收时发生冲突，A 感知不到 C
	![|300](Images/Pasted%20image%2020241212210312.png)
暴露站点问题
	由于非竞争者距离发送站点太近，从而导致介质非竞争者不能发送数据的问题称为暴露站点问题
	B 向 A 发送数据，被 C 监听到，导致 C 不能向 D 发送数据
	![|300](Images/Pasted%20image%2020241212210343.png)
MACA
- 发送站点刺激接收站点发送应答短帧，从而使得接收站点周围的站点监听到该帧，并在一定时间内避免发送数据
- A 向 B 发送 RTS(Request To Send)帧（请求发送帧），A 周围的站点在一定时间内不发送数据，以保证CTS 帧返回给 A
- B 向 A 回答 CTS(Clear To Send)帧（允许发送帧），B 周围的站点在一定时间内不发送数据，以保证 A 发送完数据
- A 开始发送，若发生冲突的话（比如 B 和 C 同时给 A 发 RTS），在期望的时间间隔内没有侦听到 CTS 帧，等待随机时间，再重新开始
![|500](Images/Pasted%20image%2020241212210733.png)
## 以太网
分为经典以太网(速度 3~10Mb/s)和交换式以太网
- 最大帧长：1518B（数据部分最大 1500B）
- 最小帧长：64B（数据部分最大 64B，不足则填充）
MAC 地址
- 48 位
- 目的地址的单播、广播、多播
	- 单播帧（1 对 1），收到的帧的 MAC 地址和本站的硬件地址相同
	- 广播帧（1 对全体）全 1 地址
	- 多播帧（1 对多）
	- 广播、多播只能作为目的地址出现
### 二进制指数后退的 CSMA/CD
- 发生第一次冲突后，各个站点等待 0 或 1 个时槽再开始重传
- 发生第二次冲突后，各个站点随机选择等待 0，1，2，3 个时槽再开始重传
- 第 i 次冲突后，在$0\sim2^i-1$间随机地选择一个等待的时槽数，再开始重传
- 10 次冲突后，选择等待的时槽数固定在 0 至 1023 间
- 16 次冲突后，发送失败，报告上层
### 共享式以太网
物理层扩展以太网
	集线器：所有站在一个冲突域，平分带宽，只工作在物理层，接口仅简单的转发比特，不进行碰撞检测，但有少量容错能力
	![|400](Images/Pasted%20image%2020241213094027.png)
	![|400](Images/Pasted%20image%2020241213094422.png)
数据链路层扩展以太网
	网桥：一般有两个端口来连接不同的以太网，注意，由于网桥工作在数据链路层，使用网桥扩展不会使两个独立的碰撞域合并成一个更大的碰撞域
	![|500](Images/Pasted%20image%2020241213094849.png)
	网桥转发表建立过程：网桥上电启动时，转发表为空，假设网络依次进行了如下通信 A->B、D->A、C->A
	![|500](Images/Pasted%20image%2020241213095823.png)
	(1) A 发送 A->B 的单播帧，与主机 A 处于同一网段中的主机 B、主机 C 和网桥的接口 1 都会收到该单播帧
	(2) 主机 B 中的网卡根据该单播帧的目的 MAC 地址 B 可知，这是发给自己的帧，接收该帧
	(3) 主机 C 中的网卡知道不是发给自己的帧，丢弃
	(4) 网桥首先将该帧的源 MAC 地址 A 与进入网桥的接口号 1 作为一条记录登记到转发表，之后网桥在转发表中查找该单播帧的目的 MAC 地址 B，但没有找到，只能通过除接收该帧的接口 1 以外的其他接口转发该单播帧，从而转发到另一个网段
	(5) 其他网段中的主机会全部丢弃
	![|500](Images/Pasted%20image%2020241213100524.png)
	D->A，此时网桥转发通过查找转发表会知道从接口 1 转发
	![500](Images/Pasted%20image%2020241213100741.png)
	C->A，此时网桥转发通过查找转发表发现 C、A 处于同一网段，A 能够直接收到该帧而不需要借助于网桥的转发，网桥会丢弃该帧
### 交换式以太网
交换式集线器常称为以太网交换机或二层交换机
交换机：每个端口可以连接不同设备并自动切换不同速率
![](Images/Pasted%20image%2020241213101447.png)
- 如果交换机的接口直接和计算机或交换机连接，可以工作在全双工方式，并能在自身内部同时连通多对接口，使得每一对互相通信的计算机独享带宽，此时也不需要 CSMA/CD
- 当交换机的接口连接共享媒体的集线器时，就只能使用 CSMA/CD 协议并只能工作在半双工方式下
一般交换机采用存储转发，将整个帧先缓存后再进行处理。某些采用直通交换方式，在接收帧的同时立即按帧目的 MAC 地址决定该帧的转发接口，但不检错可能会将一些无效帧转发给其他主机
- 主机发送单播帧情况：
![|500](Images/Pasted%20image%2020241213102326.png)
- 主机发送广播帧情况：
![|500](Images/Pasted%20image%2020241213102616.png)
虽然效果一样，但原理不同
共享式：集线器直接转发，各主机根据目的 MAC 地址判断是广播帧接收
交换式：交换机发现是广播帧，从除进入接口外的所有接口转发
- 多主机同时通信：
![500](Images/Pasted%20image%2020241213103057.png)
小结：
![](Images/Pasted%20image%2020241213103140.png)
快速以太网：电缆最大长度降低到原来的 1/10
千兆以太网
	全双工模式，不用 CSMA/CD
	半双工模式，用 CSMA/CD
		载波扩充
		帧突发
万兆以太网：只支持全双工
## 802.11 无线局域网
### CSMA/CA
不能避免所有的碰撞，只能尽量减少碰撞发送的概率
NAV 网络分配向量：指出必须经过多长时间才能完成帧的这次传输、才能使信道转入空闲状态
![|500](Images/Pasted%20image%2020241212212406.png)
![|500](Images/Pasted%20image%2020241212212757.png)
![|500](Images/Pasted%20image%2020241212212811.png)
SIFS 最短帧间间隔，用来分隔一次对话的各帧，包括 ACK 帧、CTS 帧等
DIFS 用来发送数据帧和管理帧
![|425](Images/Pasted%20image%2020241212212956.png)
802.11 使用虚拟载波监听，让源站把它要占用信道的时间及时通知给所有其他站，使其他所有站在这一段时间都停止发送帧
## 虚拟局域网 VLAN
VLAN 并不是一种新型网络，它只是局域网能够提供给用户的一种服务
![|300](Images/Pasted%20image%2020241213111702.png)
广播风暴：网络中出现大量广播帧而引起性能恶化，划分 VLAN 可有效控制广播风暴，提高网络性能
- 静态 VLAN（基于端口的 VLAN）
  ![|400](Images/Pasted%20image%2020241213112331.png)
- 动态 VLAN
	- 基于 MAC 地址的 VLAN
	  ![|400](Images/Pasted%20image%2020241213112427.png)
	- 基于子网的 VLAN
		  根据所连计算机的 IP 地址决定端口所属的 VLAN
	- 基于用户的 VLAN
		  根据计算机上当前登录的用户决定端口所属的 VLAN
汇聚链接：能够转发多个不同 VLAN 的通信的端口
![|650](Images/Pasted%20image%2020241213112657.png)
802.1Q 帧包含了 4B 的 VLAN 标签字段，一般不由用户主机处理，而是由以太网交换机来处理
![](Images/Pasted%20image%2020241213112836.png)
如果使用三层交换机
![](Images/Pasted%20image%2020241213113055.png)
## 习题
1. 假设一个采用 CSMA/CD 协议的 100Mb/s 局域网，最小帧长 128B，则在一个冲突域内两个站点之间的单向传播时延最多是？
   最小帧长 = 传播时延 \* 数据传输速率 \* 2 也就是一个 RTT
   单向传播时延最多是 $\frac{128B}{12.5MBps*2}=5.12*10^{-6s}$
2. ![](Images/Pasted%20image%2020241212205527.png)
   A、C、D 静态划分不会产生冲突，选 B
3. ![](Images/Pasted%20image%2020241212205615.png)
   选B，不适用于无线网络，无线网络用 CSMA/CA
4. 以太网中最短帧长 1000bit，最远两点相距离 100m，数据在光纤中的传播速率为 $2×10^8$ 𝑚/𝑠，问最大发送速率？
   RTT= $\frac{2*100m}{2*10^8m/s}=10^{-6}s$
   最大传输速率 = $\frac{1000bit}{10^{-6}s}=1Gb/s$
5. 无线局域网面对暴露站问题可采用 RTS/CTS 解决（×）
6. 有 10 台计算机，若分别连接到 10Mb/s 的以太网集线器上、100 Mb/s 的以太网集线器上、10Mb/s 的以太网交换机上，则每一台计算机平均能得到的带宽分别是？
   1Mb/s、10Mb/s、10Mb/s
   （1）的答案=10Mb/s /10=1Mb/s
   （2）的答案=100Mb/s /10=10Mb/s
   （3）每个端口都是 10Mb/s 的带宽，即每个站都是 10Mb/s
7. ![](Images/Pasted%20image%2020241212213229.png)
   选 A，DIFS
8. 关于无线局域网，下列说法正确的是？
   (A)为了减少冲突发生，无线局域网在发送信号时需要进行冲突检测
   (B)无线局域网可采用 CSMA/CD 来进行冲突检测
   (C)采用 RTS/CTS 方式，如果某一站点监听到 CTS 信号，但没有监听到对应 RTS，那么该站点不需要为了避免冲突而静默
   (D)SIFS,DIFS,PIFS 的帧间间隔，主要是用于控制站点消息的优先级
   A、B× 无线局域网不做冲突检测，也不用 CSMA/CD
   C× 只收到 CTS 帧也要保持静默
   D 正确
9. 一个 CSMA/CD 协议的局域网中，介质为电缆，链路速率为 1Gbps，信号传播速率为 200000km/s，若最短数据帧长度增加 50 字节，则协议允许最远两站增加？
   最小数据帧长度增加 400bit，传输速率为 1Gbps，则最大往返时间允许增加 400bit/1Gbps=400ns，即最大端到端往返时延增加了 400ns，允许增加的距离 $\frac{1}{2}×400×10^{−9}𝑠×2×10^8𝑚/𝑠=40𝑚$
10. IEEE802.3 局域网中使用的 MAC 协议是CSMA/CD
11. 下列那种不是VLAN划分方式？
    A.基于端口
    B.基于MAC
    C.基于端口号
    D.网络地址
    猜测 C 的端口号是指的传输层端口号，选 C
# 网络层
向上提供如下两种服务
![](Images/Pasted%20image%2020241213114356.png)
## IP 协议
![](Images/Pasted%20image%2020241213114500.png)
如下 IP 协议需要使用：
	ARP：地址解析协议
	RARP(已弃用)：逆地址解析协议
如下需要使用 IP 协议：
	ICMP：网际控制报文协议
	IGMP：网际组管理协议
### IPv4 头格式
![](Images/Pasted%20image%2020241214124406.png)
首部长度字段单位是字(4B)，因为首部的固定长度是 20B，所以首部长度字段的最小值是 0101(5)
首部长度字段最大值是 1111，对应首部长度 15\*4B = 60B
当 IP 分组的首部长度不是 4B 的整数倍时，必须用最后的填充字段填充
总长度字段：首部和数据之和的长度，单位是 B，总长度字段 16 位，因此整个 IP 数据报最大长度为 65535 字节
生存时间 TTL：跳数为单位，路由器转发 IP 数据报时，TTL-1，若不为 0 就转发，否则丢弃。设置 TTL=1，则只能在局域网中传送
IPv6 中，路由器不再计算首部校验和
![|500](Images/Pasted%20image%2020241214132102.png)
- 标识：属于同一个数据报的各分片数据报应该有相同的标识
- 标志(3b)：
    DF 位：1 表示不允许分片，0 表示允许分片
	MF 位：1 表示后续还有分片，0 表示这是最后一个分片
	保留位：必须为 0
- 片偏移：指出分片数据报的数据载荷部分在原数据报偏移位置，<font color="#c0504d">以 8B 为单位</font>
![|500](Images/Pasted%20image%2020241214132722.png)
![|500](Images/Pasted%20image%2020241214132902.png)
![](Images/Pasted%20image%2020241214135635.png)
![](Images/Pasted%20image%2020241214135736.png)
![](Images/Pasted%20image%2020241214135831.png)
![](Images/Pasted%20image%2020241214140528.png)
![](Images/Pasted%20image%2020241214151718.png)
![](Images/Pasted%20image%2020241214151810.png)
### IPv4
![](Images/Pasted%20image%2020241213140107.png)
同一网络中，不同主机(或路由器)的接口的 IPv4 地址的网络号必须相同，表示它们属于同一个网络，而主机号必须各不相同
![](Images/Pasted%20image%2020241213140256.png)
分类编址的 IPv4 地址分为五类：
![](Images/Pasted%20image%2020241213140430.png)
- 只有 A 类、B 类、C 类地址可以分配给网络中主机(或路由器)的各接口
- <font color="#c0504d">主机号全 0 的地址是网络地址、主机号全 1 的地址是广播地址</font>，都不能分配给网路中主机(或路由器)的各接口
A 类地址细节：
![](Images/Pasted%20image%2020241213141107.png)
故 A 类最小可指派的网络是 1，网络地址为 1.<font color="#c0504d">0.0.0</font>
A 类最大可指派的网络是 126，网络地址为 126.<font color="#c0504d">0.0.0</font>
A 类最大网络号是 127(0111 1111)作为本地环回测试地址，不能指派
	最小的本地环回测试地址为 127.0.0.1
	最大的本地换回测试地址为 127.255.255.254
可指派的 A 类网络的数量为 1~126，每个 A 类网络中可分配的地址数量为 $2^{24}-2$
除 A 类外，B、C类最小网络号也是最小可指派的网络号
![](Images/Pasted%20image%2020241213141920.png)
如下地址在特定情况下使用
![](Images/Pasted%20image%2020241213142302.png)
![](Images/Pasted%20image%2020241213142753.png)
无分类编址
CIDR 记法：
![|400](Images/Pasted%20image%2020241213142903.png)
路由聚合/构造超网：
![|650](Images/Pasted%20image%2020241213143433.png)
R2 路由记录变成 172.1.4.0/22，R1
最长匹配：路由器查表转发分组时发现有多条路由条目匹配，选择<font color="#c0504d">网络前缀最长</font>的那条路由条目
CIDR+VLSM(变长子网掩码)可尽量减少地址浪费
![](Images/Pasted%20image%2020241213144235.png)
### IPv4 和 MAC 地址
![](Images/Pasted%20image%2020241213144349.png)
IP 地址是网际层和以上各层使用的地址，源 IP 地址和目的 IP 地址封装在 IP 数据报首部
MAC 地址是网络接口层中数据链路层使用的地址，源 MAC 地址和目的 MAC 地址封装在帧首部
![](Images/Pasted%20image%2020241213144831.png)
### ARP
地址解析协议：通过已知 IP 地址找到相应的 MAC 地址
RARP 协议：通过 MAC 地址找到相应的 IP 地址
````tab
tab: 1
![](Images/Pasted%20image%2020241213151628.png)
tab: 2
![](Images/Pasted%20image%2020241213151933.png)
tab: 3
![](Images/Pasted%20image%2020241213152013.png)
tab: 4
![](Images/Pasted%20image%2020241213152118.png)
tab: 5
![](Images/Pasted%20image%2020241213152246.png)
tab: 6
![](Images/Pasted%20image%2020241213152420.png)
tab: 7
![|300](Images/Pasted%20image%2020241213152441.png)
tab: 8
![](Images/Pasted%20image%2020241213152642.png)
tab: 9
![](Images/Pasted%20image%2020241213152720.png)
````
ARP 高速缓存表中，动态类型记录自动获取，生命周期默认 2min，静态类型记录手工设置，不同 OS 生命周期不同
严格来说，MAC 是对网络上各接口的唯一标识，而不是对网络上各设备的唯一标识
ARP 作用范围：逐段链路或逐个网络使用
### DHCP
动态主机配置协议，每个网络一个 DHCP 服务器，和 ARP 类似，主机通过在本网络中广播请求获取 IP 地址
### IP 数据报的发送和转发
同一个网络中的主机之间可以直接通信，这属于直接交付。不同网络中的主机之间的通信，需要通过默认网关(路由器)来中转，这属于间接交付。
判断是否在同一网络中：
![](Images/Pasted%20image%2020241214121355.png)
1. 主机发送 IP 数据报
	- 直接交付：源主机通过 ARP -> 同一网络中的目的主机的 MAC 地址，然后将 IP 数据报封装成帧后发送给目的主机
	- 间接交付：源主机通过 ARP -> 同一网络中的默认网关的 MAC 地址，然后将 IP 数据报封装成帧后发送给默认网关
2. 路由器转发 IP 数据报
   路由器收到某个正确的 IP 数据报(TTL 未结束且首部无误码)，基于 IP 数据报首部中的目的 IP 地址在自己的路由表中进行查询
   - 如果查询到匹配的路由条目，就按照该路由条目的指示进行转发
   - 如果查询不到匹配的路由条目，就丢弃该 IP 数据报，并向发送该 IP 数据报的源主机发送<font color="#c0504d">差错报告</font>
![|500](Images/Pasted%20image%2020241214122135.png)
如果路由器收到的是目的地址为广播地址的 IP 数据报，则<font color="#c0504d">不会</font>对该 IP 数据报进行转发，路由器隔离广播域
![|500](Images/Pasted%20image%2020241214122416.png)
![|500](Images/Pasted%20image%2020241214122457.png)
中间路由只会对 IP 包进行分片，而不会重组，分片只会在到达目的主机上重组，源主机也可以对 IP 包进行分片
![|500](Images/Pasted%20image%2020241214153401.png)
![|500](Images/Pasted%20image%2020241214153825.png)
每个分片独立传输，可能走不同的路由路径，到达时间和顺序也无法预测
![|500](Images/Pasted%20image%2020241214153550.png)
## 静态路由配置
![](Images/Pasted%20image%2020241214155320.png)
路由表中前两条路由条目，是 R1 根据自己的接口 0 和 1 各自所配置的 IP 地址和地址掩码，自行得出的直连路由
第三条路由条目是由人手动配置的非直连路由，属于静态路由配置
### 默认路由
当路由器收到 IP 数据报且查询不到匹配的路由条目时，会按默认路由条目中“下一跳”进行转发
默认路由条目中的“目的网络”填写 0.0.0.0/0，0.0.0.0 表示任意网络，网络前缀“/0” 是最短的网络前缀，使得匹配优先级最低
### 特定主机路由
![](Images/Pasted%20image%2020241214162959.png)
只要是去往该特定主机的 IP 数据报，都会按 R1 路由表中的这条特定主机路由条目中“下一跳”的指示从 R1 接口 1 转发给路由器 R2 的接口 0，再由 R2 的接口 1 直接交付给该特定主机
## VPN 和 NAT
![](Images/Pasted%20image%2020241214165440.png)
NAT 技术：
![](Images/Pasted%20image%2020241214165558.png)
![](Images/Pasted%20image%2020241214165811.png)
NAPT 技术：
将 IP 地址和端口号一起转换
![](Images/Pasted%20image%2020241214165914.png)
NAT/NAPT 缺陷：外网主机无法主动与内网主机通信
## IPv6
地址 128 位，首部长度变为固定 40B
![](Images/Pasted%20image%2020241214170751.png)
地址 8000：0000：0000：0000：0123：4567：89AB：CDEF
优化一：组内可省略前导 0，例如:0123:->:123:
优化二：由 16 个 0 位构成的多个组可用一对冒号代替，例如:0000:0000:->::
上述地址可用优化成：8000::123:4567:89AB:CDEF
优化三：IPv4 地址可用写成 ::192.31.20.46
![|500](Images/Pasted%20image%2020241214171147.png)
![|500](Images/Pasted%20image%2020241214171155.png)
## 路由算法和选择协议
![](Images/Pasted%20image%2020241214171541.png)
![](Images/Pasted%20image%2020241214171636.png)
### RIP
RIP（Routing Information Protocol）路由信息协议
要求 AS(自治系统)内每一个路由器都要维护从它到自己 AS 内其他每个网络的距离记录，称为距离向量 D-V
RIP 用<font color="#c0504d">跳数</font>度量到达目的网络的距离
- 路由器到直连网络距离定义为 1
- 路由器到非直连网络的距离为所经过路由器数量+1
- 允许一条路径最多只能包含 15 个路由器，距离=16 $\iff$ 不可达
![](Images/Pasted%20image%2020241214172145.png)
RIP 找通过路由器数量最少的路由
若到达同一目的网络有多条距离相等的路由时，可进行等价负载均衡
RIP 基本工作原理：
1. 仅和相邻路由器交换信息
2. 交互的内容是自己的路由表
3. 周期性交换（例如 30s）
![](Images/Pasted%20image%2020241214172423.png)
D-V 算法收敛过程：
![](Images/Pasted%20image%2020241214173420.png)
改成 C 是指：D 通过 C 能到的目的网络
![|650](Images/Pasted%20image%2020241214173624.png)
![|650](Images/Pasted%20image%2020241214173732.png)
![|650](Images/Pasted%20image%2020241214173842.png)
![|650](Images/Pasted%20image%2020241214174005.png)
![](Images/Pasted%20image%2020241214174159.png)
缺陷：坏消息传的慢/距离无穷计数/路由环路
![](Images/Pasted%20image%2020241214174412.png)
![](Images/Pasted%20image%2020241214174541.png)
初始时：
![](Images/Pasted%20image%2020241214174604.png)
检测到不可达后：
![](Images/Pasted%20image%2020241214174635.png)
最后更新：
![](Images/Pasted%20image%2020241214174724.png)
### OSPF
为克服 RIP 上述缺点而开发的
使用 Dijkstra 的最短路径算法
不会产生路由环路，基于链路状态 LS
链路状态：路由器有哪些邻居，相应链路的“代价”，代价用什么自行决定
相邻路由器之间通过交换<font color="#c0504d">问候(Hello)分组</font>，建立和维护邻居关系
Hello 分组封装在 <font color="#c0504d">IP</font> 数据报中，发往组播地址 224.0.0.5
![](Images/Pasted%20image%2020241214175442.png)
发送周期为 10s
40s 未收到来自邻居路由器的 Hello 分组，认为邻居不可达
![](Images/Pasted%20image%2020241214175544.png)
![](Images/Pasted%20image%2020241214175833.png)
- 数据库描述分组：
  向邻居路由器给出自己的链路状态数据库(LSDB)中的<font color="#c0504d">所有</font>链路状态项目的摘要信息
- 链路状态请求分组：
  向邻居路由器请求发送<font color="#c0504d">某些</font>链路状态项目的详细信息
- 链路状态更新分组(LSU)：
  路由器使用这种分组将其链路状态进行洪泛发送，更新全网链路状态
- 链路状态确认分组：
  对 LSU 的确认分组
每个路由器会产生链路状态通告(LSA)，LSA 包含：
- 直连网络的链路状态信息
- 邻居路由器的链路状态信息
LSA 被封装在 LSU 中，采用洪范法发送，即每个接收到消息的节点将消息复制并发送给除了消息来源外的所有其他节点
![](Images/Pasted%20image%2020241214180639.png)
![|500](Images/Pasted%20image%2020241214180718.png)
![|500](Images/Pasted%20image%2020241214181242.png)
D-V 算法，C->A = min{C->B+B->A，C->D+D->A，C->E+E->A} = min{2+6，4+12，1+10} = 8

| 目的路由器 | 距离  | 下一跳路由器 |
| :---: | :-: | :----: |
|   A   |  8  |   B    |
|   B   |  2  |   B    |
|   D   |  3  |   E    |
|   E   |  1  |   E    |
|   F   |  2  |   E    |
B）若采用链路状态路由算法，C 发出的链路状态信息？
LSA 只包含直连网络和邻居路由器，C 没有直连网络

| 序号  | 距离  |
| :-: | :-: |
|  B  |  2  |
|  D  |  4  |
|  E  |  1  |
C）如果网中两种算法分别都用，路由稳定后，C 的路由表是否相同？
收敛都是最短路径，相同
![](Images/Pasted%20image%2020241214182628.png)
### BGP
BGP 属于外部网关协议 EGP，在不同 AS 中，度量路由的代价可能各不相同，所以 AS 之间难以找到最佳路由，BGP 只能寻找一条不成环的、能到目的网络的路由
![](Images/Pasted%20image%2020241214183425.png)
不同 AS 的 BGP 发言人必须先建立 <font color="#c0504d">TCP 连接</font>
在 TCP 连接上交换 BGP 报文以建立 BGP 会话，利用 BGP 会话交换路由信息
EBGP：位于不同AS的BGP路由器之间的BGP对等体关系
IBGP：位于相同 AS的BGP路由器之间的BGP邻接关系
每个 BGP 路由器维护了到达每个目标的路径的成本和用过的路径。这种方法称为路径向量协议(path vector protocol)。路径包含了下一跳路由器(有可能在 ISP 的另一侧，不一定相邻)和该路径遵循的一系列 AS 或者 AS 路径(ASpath)
### ICMP
主机或路由器使用 ICMP 来发送差错报告报文和询问报文
ICMP 差错报告报文包括如下：
1. 终点不可达：当路由器或主机不能交付数据报时，向源点发送终点不可达
2. 源点抑制：当路由器或主机由于拥塞而丢弃数据报时，向源点发送
3. 时间超过：
   当 TTL 为 0，丢弃 IP 数据报并向源点发送
   当终点在预先规定时间内不能收到一个数据报的全部数据报片，会将已收到的数据报片全部丢弃并向源点发送
4. 参数问题：首部校验和校验失败，丢弃数据报并向源点发送
5. 改变路由(重定向)：
   ![](Images/Pasted%20image%2020241214185550.png)
如下情况不应该发送 ICMP 差错报告报文：
1. 对 ICMP 差错报告报文不再发送
2. 对第一个分片的数据报片的所有后续数据报片都不发送
3. 对具有多播地址的数据报都不发送
4. 对具有特殊地址的数据报不发送
ICMP 询问报文：
1. 回送请求和回答：用于测试目的站是否可达(例如PING)
2. 时间戳请求和回答：用于时钟同步和测量时间
### IGMP
多播(也称组播)是一种实现“一对多”通信的计数，可以极大节省网络资源
在因特网上进行的多播，称为 IP 多播
![|350](Images/Pasted%20image%2020241214200243.png)
IPv4 多播地址：224.0.0.0~239.255.255.255
![](Images/Pasted%20image%2020241214200354.png)
多播地址只能做目的地址
使用同一个 IP 多播地址的所有主机构成一个多播组，每个多播组成员可以随时变动，一台主机可以属于几个多播组。非多播组的成员也可以向多播组发送 IP 多播数据报
IP 多播数据报不能保证一定能交付给所有成员，只是尽力
IGMP：网际组管理协议，让连接在本地局域网上的多播路由器知道本局域网是否有主机加入或退出某个多播组，即 IGMP 仅在本网络有效，使用 IGMP 并不能知道多播组所包含的成员信息

|  协议  | 直接封装的协议 |
| :--: | :-----: |
| RIP  |   UDP   |
| OSPF |   TCP   |
| BGP  |   IP    |
| ICMP |   IP    |
| IGMP |   IP    |
## SDN
SDN：软件定义网络，控制平面运行在软件中，在操作上可以和数据平面完全分离
控制平面：选择路径和决定如何处理转发流量的软件和逻辑
数据平面：以硬件为基础，对数据包执行实际的查找工作
![|500](Images/Pasted%20image%2020241214201246.png)
## 习题
1. 下列网络设备中，能抑制广播风暴的是？
   A) 中继器 B) 集线器 C) 网桥 D) 路由器
   
|     设备     | 工作层次  | 隔离冲突域 | 隔离广播域 |
| :--------: | :---: | :---: | :---: |
|    中继器     |  物理层  |   ×   |   ×   |
|    集线器     |  物理层  |   ×   |   ×   |
|     网桥     | 数据链路层 |   √   |   ×   |
| 交换机(多端口网桥) | 数据链路层 |   √   |   ×   |
|    路由器     |  网络层  |   √   |   √   |

   选 D
2. ![](Images/Pasted%20image%2020241214123245.png)
   IP 路由器工作在 TCP/IP 体系结构的网际层(或称 IP 层)，TCP/IP 体系结构的网际层不负责可靠传输
3. ![](Images/Pasted%20image%2020241214123628.png)
   主机 1 子网掩码 255.255.255.0，主机 1 IP 111.123.15.4，所以主机 1 所在网段为 111.123.15.0
   WWW 服务器 IP 111.123.15.3/<font color="#c0504d">24</font>，所以 WWW 服务器所在网段为 111.123.15.0 和主机 1 在同一网段，可以访问
   主机 1 的默认网关为 111.123.15.2，是 DHCP 服务器 IP 地址，DHCP 服务器不具有路由器功能，无法将 IP 分组转发到 Internet
4. ![](Images/Pasted%20image%2020241214164036.png)
   192.168.64.18 第 3 段的 64 变成十进制 192.168.0100 0000.18
   分别与子网掩码
   11111111 11111111 11100000 00000000
   11111111 11111111 11000000 00000000
   11111111 11111111 10000000 00000000与操作，分别得到网络号：
   192.168.64.0 与 192.168.160.0 不匹配
   192.168.64.0 与 192.168.192.0 不匹配
   192.168.0.0 与 192.168.128 不匹配
   所以从默认路由转发，也就是接口 3
   192.168.172.17 第 3 段的 172 变成十进制 192.168.1010 1100.17
   做与操作，分别得到网络号：
   192.168.160.0 与 192.168.160.0 匹配
   192.168.128.0 与 192.168.192.0 不匹配
   192.168.128.0 与 192.168.128 匹配
   最长前缀匹配原则，接口 0
5. 假设一个NAT服务器其公网地址为205.56.79.35，并且有如下的表项，那么当一个IP地址为192.168.32.56端口为21 的分组进入公网的时候，转换后的源IP地址和端口号是？
   ![](Images/Pasted%20image%2020241214170333.png)
   任何时候当一个向外发送的分组进入到NAT服务器的时候，源地址被真实的公网地址所取代，而端口域被转换为一个索引值 选 A
# 传输层
![](Images/Pasted%20image%2020241214201706.png)
传输层向高层用户屏蔽下面的细节，使应用进程好像是端到端通信
![](Images/Pasted%20image%2020241214202026.png)
## TCP
TSAP（传输服务接入点）表示传输层的一个特定端点
NSAP（网络服务接入点）表示网络层的一个特定端点（例如 IP）
TSAP = IP + 端口号
TCP 在不可靠的互联网络上提供可靠的端到端的字节流传输
所有 TCP 连接都是全双工的，并且是点到点的
TCP 不支持多播或广播传输
一个 TCP 连接是一个字节流，而不是消息流。端到端之间不保留消息的边界
TCP 连接：逻辑连接，双方 TCP 实体维持连接状态，中间的路由器感知不到 TCP 连接
![](Images/Pasted%20image%2020241214203628.png)
- 源端口：用来标识发送该 TCP 报文段的应用进程
- 目的端口：用来标识接收该 TCP 报文段的应用进程
- 序号：在建立连接时由内核生成的随机数作为其初始值，指出本 TCP 报文段数据载荷的<font color="#c0504d">第一个字节的序号</font>，序号增加到最后一个后，下一个序号又回到 0
![](Images/Pasted%20image%2020241214205006.png)
- 确认号：指出期望收到对方下一个 TCP 报文段的数据载荷的第一个字节序号，同时也是对之前收到的所有数据的确认
  若确认号=n，表示到序号 n-1 为止的所有数据都已正确接收，期望接收序号为 n 的数据
- ACK：取值为 1 时，确认号字段才有效
  TCP 规定在连接建立后所有传送的 TCP 报文段都必须把 ACK 置 1
![|405](Images/Pasted%20image%2020241214205518.png)
- 数据偏移：以 4B 为单位，指出 TCP 报文段的首部长度
  首部固定长度为 20B，则数据偏移字段的最小值是 0101
- 窗口：以 B 为单位，指出发送本报文段的一方的接收窗口
  窗口值是接收方的接收能力，通过窗口值实现流量控制
- 校验值：检查范围包括 TCP 报文段首部和数据载荷两部分
  计算时，要在 TCP 报文段前加上 12B 的伪首部
- SYN：在 TCP 连接建立时用来同步序号
- FIN：用来释放 TCP 连接
- RST：用来复位 TCP 连接
- PSH：接收方的 TCP 收到 PSH=1 的报文段会尽快上交应用进程，而不必等到接收缓存都填满后再向上交付
- 紧急指针：以 B 为单位，指明紧急数据的长度
- URG：取值=1 时，紧急指针字段有效，可将紧急数据插队到发送缓存最前面，并立刻封装到一个 TCP 报文段中进行发送
- 可选字段：
	- MSS：TCP 报文段数据载荷部分的最大长度
	- SACK：选择确认，发送方可以显式地知道接收方已经接收了哪些数据，并因此可以确定哪些数据应该重传
- 填充：保证报文段首部能被 4 整除
### TCP 连接建立
![](Images/Pasted%20image%2020241214212027.png)
![](Images/Pasted%20image%2020241214212044.png)
![](Images/Pasted%20image%2020241214212127.png)
![](Images/Pasted%20image%2020241214212150.png)TCP 的标准规定，ACK 报文段可以携带数据。但如果不携带数据则不消耗序号，在这种情况下，下一个数据报文段的序号仍是 seq=x+1。这时，TCP 连接已经建立，A 进入 ESTABLISHED(已建立连接)状态。
### TCP 连接释放
![](Images/Pasted%20image%2020241214212348.png)
![](Images/Pasted%20image%2020241214212412.png)
![](Images/Pasted%20image%2020241214212434.png)
![](Images/Pasted%20image%2020241214212457.png)
![](Images/Pasted%20image%2020241214212506.png)
![](Images/Pasted%20image%2020241214212538.png)
MSL：最长报文段寿命，之所以要等待 2MSL
1. 为了保证 A 发送的最后一个 ACK 报文段能到 B
2. A 发送完最后一个 ACK 报文段后，再经过时间 2MSL 可以使本连接持续的时间内所产生的所有报文段都从网络中消失，下次新的连接中不会出现旧的连接请求报文段
### 可靠传输机制
发送窗口大小 = min{拥塞窗口，接收窗口}
![](Images/Pasted%20image%2020241214213819.png)
![](Images/Pasted%20image%2020241214213924.png)
![](Images/Pasted%20image%2020241214213934.png)
![](Images/Pasted%20image%2020241214214009.png)
通过 rwnd 接收窗口控制发送流量：
![](Images/Pasted%20image%2020241214214927.png)
### 拥塞控制
![|650](Images/Pasted%20image%2020241214215119.png)
Tahoe，数据丢失
![|650](Images/Pasted%20image%2020241214215131.png)
MSS：最大报文段
慢开始算法：主机初始发送报文段时，可先设置 cwnd=1(一个MSS数值)
![](Images/Pasted%20image%2020241214215509.png)
一个传输轮次所经历的时间近似 RTT：把 cwnd 允许发送的报文段都连续发送出去，并收到了对已发送的最后一个字节的确认
慢开始门限 ssthresh：
当 cwnd < ssthresh 时，使用慢开始算法
当 cwnd > ssthresh 时，使用拥塞避免算法
当 cwnd = ssthresh 时，两个算法都可以
拥塞避免算法：每经过一个 RTT 把发送方的 cwnd+1 而不是加倍

## 习题
1. 若客户首先向服务器发送 FIN 段请求断开 TCP 连接，则当客户收到的服务器发送的 FIN 段并向服务器发送 ACK 段后，TCP 状态转换为？
   A.CLOSE_WAIT
   B.TIME_WAIT
   C.FIN_WAIT_1
   D.FIN_WAIT_2
   见 TCP 释放连接图，选 B
2. 主机甲向主机乙发送一个(SYN=1，seq=11220)的 TCP 段，期望与主机乙建立 TCP 连接，若主机乙接受该连接请求，则主机乙向主机甲发送的正确的 TCP 段应该是？
   A. (SYN=1,ACK=1,seq=11220,ack=11220)
   B. (SYN=1,ACK=1,seq=11221,ack=11221)
   C. (SYN=0,ACK=0,seq=11221,ack=11221)
   D. (SYN=0,ACK=1,seq=11220,ack=11220)
   选 B
3. 假设主机甲通过 TCP 向主机乙发送数据，部分过程如下图所示。甲在 t0 时刻发送了一个序号 seq=501、封装 200 B 数据的报文段段，在 t1 时刻收到乙发送的序号 seq=601、确认序号 ack_seq=501、接收窗口 rcvwnd=500 B 的段，则甲在未收到新的确认段之前可以继续向乙发送的字节序号范围是什么？
   ![|500](Images/Pasted%20image%2020241214214352.png)
   接收窗口rcvwnd=500B，ack_seq=501，甲 seq501~700 已发送未收到确认，发送窗口剩余 701~1000 可继续发送
4. 主机 A 和主机 B 之间采用 TCP 传输，A 向 B 传输 3 个 TCP 段，其有效载荷长度分别为 200,300,500 字节，第三个 TCP 段起始序号为 800，A 向 B 传输第一个段成功，第二个段丢失，则主机 B 在收到第三个段后，返回的确认序号是？
   第三个 TCP 段起始序号为 800，第三段是 300 字节，可知第二段的起始序号为 500，主机 B 收到第一个和第三个段，没收到第二个段，确认号是期望收到第二个段，所以是确认号是 500