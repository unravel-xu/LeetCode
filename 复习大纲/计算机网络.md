# 绪论
层次间接口定义了下层向上层提供哪些原语操作和服务
协议的组成：
	语法：二进制形式表示的命令和相应的结构
	语义：由发出的命令请求，完成的动作和回送的响应组成的集合
	定时关系：相关事件顺序的说明
网络体系结构不提供协议内部实现细节
服务：某一层向它上一层提供的一组原语(操作)
服务对用户可见，协议对用户不可见
服务访问点 SAP：
	任何层间服务是在接口的 SAP 上进行
	每个 SAP 有唯一的识别地址
	每个层间接口可以有多个 SAP
接口数据单元 IDU：
	IDU 是通过 SAP 进行传送的层间信息单元
	IDU 由上层的服务单元 SDU 和接口控制信息 ICI 组成
协议数据单元 PDU：
	第 N 层实体通过网络传送给它的对等实体的信息单元
	PDU 由上层服务数据单元 SDU 或其分段和协议控制信息 PCI 组成
	分段和重组
面向连接的服务：连接建立时，发送方、接收方和子网一起协商
	变体：消息序列（会保持消息的边界 2\*1024B 不会变成 2048B）、字节流（没有消息边界）
无连接的服务(数据报服务)：每条报文携带目标地址，可以被系统独立路由，但无法保证到达时序
点到点：网络中直接连接两个终端设备
端到端：从数据产生(信息的源头，端口)到数据接收(信息的目的地)
## OSI 参考模型
![|400](Images/Pasted%20image%2020241211134759.png)
表示层：处理两个通信系统中信息交换的表示问题，包括
	数据格式化
	数据加密和压缩
	数据转换
	异常处理
会话层：管理和控制两个通信系统之间的会话，确保数据交换按预定的会话流程进行
	会话的建立、维护和终止
	数据的同步和排序
	会话数据的分割和管理
	多个同时进行会话管理
OSI 的网络层同时支持无连接和面向连接的通信
OSI 的传输层只支持面向连接的通信
## TCP/IP 模型
![|400](Images/Pasted%20image%2020241211135204.png)
将物理层和数据链路层合并为：Host-to-Network
	物理层：物理线路上传输原始的二进制数据位
	数据链路层：在有差错的物理线路上提供无差错的数据传输
网络层：控制通信子网提供源点到目的点 IP 包传送，实现异构网络互联
传输层：端到端(端口)的数据传送服务，TCP 和 UDP
应用层：提供各种 Internet 管理和应用服务功能
TCP/IP 的网路层只支持无连接通信
TCP/IP 的传输层同时支持两种通信（和 OSI 相反）
## 5 层模型
![|400](Images/Pasted%20image%2020241211141440.png)
![|650](Images/Pasted%20image%2020241211140117.jpg)
- 物理层(什么都不加)：确保原始的数据在各种物理媒介上传输
- 数据链路层(加头加尾)：将源自网络层来的数据可靠地传输到相邻节点的目标机网络层
	  主要的协议：以太网协议
	  设备：网桥和交换机
- 网络层(加头)：负责对子网间的数据包进行路由选择、拥塞控制……
	  主要的协议：IP、ICMP、ARP、RARP
	  设备：路由器
- 传输层(加头)：网络层点对点，传输层将点对点数据传送到对应端口
	  主要的协议：TCP、UDP
	  设备：网关
- 应用层(加头)：提供访问网络服务接口
	  主要的协议：FTP、Telnet、DNS、SMTP、POP3、HTTP
## 性能指标
### 速率
KB = $2^{10}$ B
kb/s = $10^3$ bps
### 带宽
- 在模拟信号系统中，带宽是指信号所包含的各种不同频率成分所占据的<font color="#c0504d">频率范围</font>，单位 Hz
- 在计算机网络中，带宽是指单位时间内从网络中某一点到另一点所能通过的“最高数据率”，单位 b/s
### 吞吐率
在单位时间内通过某个网络（或信道、接口）的数据量
### 时延
发送时延 = $\frac{分组长度}{发送速率}$
传播时延 = $\frac{信道长度}{电磁波传播速率}$
处理时延（一般忽略）
网络时延 = 发送时延 + 传播时延 + 处理时延
1. 某数据块长度为 100MB，信道带宽为 1Mb/s，传送距离 1000km
发送时延 = $\frac{100MB}{1Mb/s} = \frac{100*2^{20}*8(b)}{10^6(b/s)} = 838.8608(s)$
传播时延 = $\frac{1000Km}{2*10^8(m/s)}=0.005(s)$
此时发送时延占主导
2. 数据块长度为 1B，信道宽度为 1Mb/s，传送距离 1000Km
发送时延 = $8*10^{-6}(s)$
传播时延 = 0.005(s)
此时传播时延占主导
### 时延带宽积
时延带宽积 = 单向传播时延 \* 带宽
当发送端连续发送数据，在所发送的第一个比特即将到达终点时，发送端已经发送了时延带宽积个比特
### 往返时间
即 RTT = 2 \* 传播时延
## 习题
1. ISO/OSI 模型中的（数据链路）层会在处理协议元数据的时候在数据首尾添加信息
2. 在 TCP/IP 模型中，由传输层相邻的下一层实现的主要功能（B）
   （A）对话管理
   （B）路由选择
   （C）端到端报文段传输
   （D）结点到结点流量控制
3. 下图描述的协议要素是
	I.语法 II.语义 III.时序
	（A）仅 I
	（B）仅 II 
	（C）仅 III
	（D）I，II，III
![|200](Images/Pasted%20image%2020241211141615.png)
	选C
4. OSI 参考模型的第 5 层（自下而上）完成的主要功能？
   会话管理
5. 在 OSI 参考模型中，直接为会话层提供服务的是？
   传输层
6. 在 OSI 参考模型中，自下而上第一个提供端到端服务的层次是？
   传输层
# 物理层
物理层接口特性：
	机械特性：接口所用接线器的形状和尺寸等
	电气特性：在接口电缆的各条线上传输比特流时，信号电压的范围等
	功能特性：接口电缆的各条信号线的作用
	过程特性：在信号线上进行比特流传输的一组操作过程
## 导向的传输媒体
同轴电缆：
	基带同轴电缆：用于数字传输，早期局域网中广泛使用
	带宽同轴电缆：用于模拟传输，有线电视的入户线
![|350](Images/Pasted%20image%2020241211174247.png)
双绞线：两根线绞在一起后
	减少相邻导线间的电磁干扰
	抵御部分来自外界的电磁干扰
	常用于电话系统，可用于模拟传输，也可用于数字传输
对于模拟传输：距离太长需要添加放大器设备，以便将衰减了的信号放大到合适的强度
对于数字传输：距离太长需要添加中继设备，以便对失真了的数字信号进行整形

光纤：多模光纤、单模光纤
光源：LED、半导体光源

|      | LED | 半导体激光 |
| :--: | :-: | :---: |
| 数据速率 |  低  |   高   |
| 光纤类型 | 多模  | 多模/单模 |
|  距离  |  短  |   长   |
|  寿命  |  长  |   短   |
|  成本  |  低  |   高   |
光纤对比铜线：
- 优点：能处理更高带宽、更少的中继器，节约成本
- 缺点：光电接口成本更高
## 非导向型传输媒体
无线电传输：一般来说低频全方向传播，穿透性好；高频直线传播，穿透性差
微波传输：一般是直线传播，穿透性差
红外传输：短距离通信，不能穿越固体
光通信：非导向性光通信提供了一种灵活、高速的无线传输方式，但它的传输距离和稳定性受到大气条件的影响
![|450](Images/Pasted%20image%2020241211160353.png)
## 编码与调制
![](Images/Pasted%20image%2020241211183126.png)
基本调制方法：
![|500](Images/Pasted%20image%2020241211185732.png)
使用基本调制方法：一个码元只能包含一个比特信息
# 数据链路层
![|400](Images/Pasted%20image%2020241211213117.png)
数据链路层来将比特流拆分成离散的帧，为每一帧计算一个名为校验和的短令牌，并将该校验和放在帧中一起传输
成帧的方法：
- 字节计数法
  帧头的字节数包括帧头本身，可能因为传输错误而出错，很少使用
  ![](Images/Pasted%20image%2020241211214754.png)
- 字节填充的标志字节法
  每一帧用特殊的字节（FLAG 标志字节）作为开始和结束，两个连续的 FLAG 代表了一帧的结束和下一帧的开始
![|500](Images/Pasted%20image%2020241211215114.png)
- 比特填充的标志比特法
  每个帧开始和结束由一个特殊的比特模式：0111 1110(0x7E)进行标记
  数据中遇到连续 5 个 1 填入一个 0
  ![](Images/Pasted%20image%2020241211215705.png)
- 物理层编码例外法
  利用保留的信号指示帧的开始和结束，比如，在 4B/5B 线路编码模式下，32 个可能的信号中有 16 个是不会被使用的
## 简单的数据链路层协议
协议 1，Utopia(乌托邦)：无流量控制或错误纠正
- 数据只能单向传输
- 其他各种条件理想化
- 只是显示要建立的基本结构
协议 2，增加流量控制：停-等式协议
- 假设信道不出错
- 假设流量是单工的
- 发送方发送一帧，等待确认(仅用于控制流量，而非确认数据是否出错)后继续发送
- 数据流量是双工的，帧可以两个方向传送（不矛盾，传回来的不是“数据”而是确认帧）
- 发送方在从网络层获取下一个数据包前必须等待，直到确认帧到来
协议 3，增加错误纠正功能
- 信道可能出错
- 假设错误能被检测出来
- 如果在一个协议中，发送方在前移到下一个数据包以前要等待一个肯定确认，这样的协议称为 ARQ 协议或 PAR 协议
- 和协议 2 相同，这类协议只在一个方向上传输数据
## 更高效率
双向传输：捎带确认
- 收到数据帧，不立即发送单独的 ACK，而是将确认信息附加在下一个自己往外的数据帧上
- 等待固定毫秒数，如果一个新的数据包很快就到来，那么这个确认就可被它捎带回去；如果在这段间隔结束以前没有新的数据包到来，那么数据链路层只需发送一个单独的确认帧
滑动窗口：
- 每一个出去的帧都包含一个序号，范围为 0~某个最大值(通常 $2^n-1$)
- 发送方维护发送窗口：序号代表已经被发送或者可以被发送，但还没有被确认的帧。新的数据包被赋予窗口中的下一个最高序号，并且发送窗口的上边界前移一格；当收到一个确认时，发送窗口的下边界也“前移一格”（具体看协议）
- 接收方维护接收窗口：对应于允许它接收的帧
回退 n 协议：
- 允许发送方在阻塞前发送 w 个帧，而不只是一个帧
- BD：$\frac{时延带宽积}{一帧的位数}$
- 当发送方连续发送帧并在一个 RTT 内收到一个 ACK，则 2BD 是发送方可以连续发出去的帧的个数
- 发送窗口最大值 w = 2BD + 1，此时是理想情况，在发送了第 2BD+1 个帧后瞬间收到了第一个帧的 ACK，发送窗口前移
- 链路利用率 $\leq \frac{w}{1+2BD}$
- 实际利用率 = $\frac{T_f}{T_s+RTT+T_a}$
  $T_s=\frac{数据帧位数}{信道带宽}$ (发送时延)，$T_f = T_s*发的帧的个数$，$T_a = \frac{确认帧位数}{信道带宽}$
- 实际最大数据传输率 = $\min{\left\{ \frac{帧长度*窗口大小}{T_s+RTT+T_a},信道带宽 \right\}}$
## GBN 协议
- 接收窗口尺寸是 1
- 若不出错，接收窗口向下移动，并发送 ACK
- 若出错，<font color="#c0504d">丢弃该帧以及后续的所有帧</font>，对后续的帧不发 ACK
	- 出错帧超时重发，出错帧的后续帧超时后也依次重发
- 采用累计确认：当 n 号帧的确认到达时，< n 号帧都会自动确认
- 发送窗口最大尺寸 $2^{n}-1$
## SR 协议
- 接收/发送窗口尺寸>1
- 收到接收窗口外的帧，丢弃
- 收到接收窗口内的帧，保留
- 如果按序收到，窗口移动一格(上下边界+1)
- 如果收到的帧不是按序，对断序位置发回 NAK，例如收到 0，1，3，发回 NAK2
- 接收方收到误码的数据分组后将其丢弃，给发送方发送相应的 NAK，发送方收到 NAK 后，会立即重传
- 按书上是累计确认，实际依情况分析，通常是逐一确认
- 发送窗口和接收窗口一般相同，且两者和 $\leq 2^n$
## 习题
1. 链路层成帧的方法不包括？
   A.偏移量法
   B.物理层编码违例法
   C.带位填充首尾字节标记法
   D.字符计数法
   选 A
2. 主机甲与主机乙之间使用GBN 协议传输数据，甲的发送窗口尺寸为 1000，数据帧长为 1000 字节，信道带宽为 100Mbps，乙每收到一个数据帧立即利用一个短帧（忽略其传输延迟）进行确认，若甲、乙之间的单向传播时延是 50ms，则甲可以达到的最大平均数据传输速率约为？
   帧长度：1000B，窗口大小：1000，$T_s=\frac{1000B}{100Mbps}$，RTT=100ms
   实际最大数据传输率 = $\min{\left\{ \frac{1000*8*1000}{\frac{1000*8}{100*10^6}+0.1}*10^{-9}Mbps,100Mbps \right\}}=\min{\{79.9361, 100\}}\approx80Mbps$
3. 主机甲通过 128kb/s 卫星链路，采用滑动窗口协议向主机乙发送数据，链路单向传播时延为 250ms，帧长为 1000 字节，不考虑确认帧的开销，为使链路利用率不小于 80%，帧序号的比特数至少是？
   ![|500](Images/Pasted%20image%2020241212190532.png)
4. 太空站到地球带宽为 128kbps 的无错信道上单向发送 512 字节的数据帧，端到端的传播延迟 300ms，确认帧长度忽略不计，接收窗口足够大，问发送窗口分别为1，15，27 时，吞吐率（数据发送速率）是多少？若要使信道利用率达到最大，则帧序号至少为多少位？
   ![|500](Images/Pasted%20image%2020241212190703.png)
5. 两地相距 3000 公里 (传播速度 6us/公里) 最大帧 64 字节，采用 GBN协议，带宽为 1.536Mbps，则若要最大限度发挥网络带宽，至少需要多少比特的序号？
   最大限度发挥网络带宽->实际最大数据传输速率=信道带宽
   ![|500](Images/Pasted%20image%2020241212190926.png)
6. 数据链路层采用 GBN 协议，发送方已经发送了编号 0~7 的帧，当计时器超时时，若发送方只收到了 0，2，3 号帧的确认，则发送方需要重发的帧数是？
   累计确认，所以是 4~7 共 4 个帧
7. 在选择重传协议中,当前发送方的发送窗口为\[1,2,3,4\]，收到了一个接收方的否定确认帧，则可能的情况是？
   (A)一定是 1 
   (B)一定是 2 
   (C)一定是 3 
   (D)可能是 1,2,3,4
