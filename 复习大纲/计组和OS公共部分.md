# 异常和中断
异常：来自 CPU 内部
中断：来自外部设备
![|500](Images/Pasted%20image%2020241113181120.png)
若异常/中断处理程序能解决问题，则回到第 i 条指令或第 i+1 条指令继续执行
若是不可恢复的致命错误，则终止用户进程，通常具体处理过程全部由 OS 软件完成
各类异常发生的流水段不同，在每条指令执行结束时，会检测有没有中断请求
- 协处理器：处理器的一个<font color="#ff0000">可选</font>部件，负责处理指令集的某个扩展
- CP0：MIPS 的系统控制协处理器，用于处理难以用常规指令解决的问题，包括 Cache 控制，异常中断控制，存储管理控制...
MIPS 异常处理流程：
1. 保存断点：设置 EPC 指向重新开始的地址
2. 关中断：设置 SR（EXL）位，强制 CPU 进入内核态，并禁用中断
3. 保存异常原因：设置 Cause 寄存器，在地址异常时，BadVAddr 也要设置
4. 从异常入口点取指令，<font color="#ff0000">之后的事情交给软件处理</font>
5. 保存现场：通过 k0 和 k1 寄存器引用一段可以保存其他寄存器的内部空间来实现
6. 读取异常原因，识别中断源：区分不同的异常，Cause 寄存器的 ExcCode 域
7. 处理异常
8. 恢复现场：恢复寄存器，清零 Cause 寄存器
9. 恢复断点：ERET 指令返回 EPC 指向的地址
10. 开中断：ERET 指令修改 SR